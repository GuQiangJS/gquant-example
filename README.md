数据文件 `300378_daily.csv` 为300378日线数据（不复权）

读取复权数据代码：

```python
# 原始未复权数据
ori_data_df = gquant.pd.read_csv('300378_daily.csv', 
                                 encoding='utf-8', 
                                 parse_dates=[0], 
                                 dtype={'code': str}).set_index(['date', 'code'])
ori_data = QA.QAData.QA_DataStruct_Stock_day(ori_data_df)
# 前复权数据
ori_data_df_qfq = ori_data.to_qfq().data
```

**代码修正记录**：
```python
# LocalDataAPI.kline方法中遗失对start,end的处理。造成数据读取有误。参考：策略测试-通道策略-ATR波幅通道.ipynb
# 增加以下代码：
if start and end:
    return df[start:end]
elif start:
    return df[start:]
elif end:
    return df[:end]
# KLManager._fetch_pick_time_kl_pd方法中遗失对start,end的处理。造成数据读取有误。参考：策略测试-通道策略-ATR波幅通道.ipynb
# 调用abupy.MarketBu.ABuSymbolPd.make_kl_df时增加传入start和end：
data = abupy.MarketBu.ABuSymbolPd.make_kl_df(target_symbol,start=self.benchmark.start,end=self.benchmark.end)
```
以上修正需要在其他策略测试时注意。否则可能会造成使用非起始日开始的数据回测时无法回测到数据。

# 测试说明

## 简单测试

- 所有测试均使用`300378`做测试。
- 所有测试时间段为`2014-01-01 ~ 2018-12-31`

**所有的简单测试结果都并不准确，仅做示例参考。** 因为：

1. 以当日收盘价作为判断依据的同时，以当日作为建仓或清仓标准是不合理的。
2. 没有考虑交易手续费

## 训练回测

- 所有测试均只采用了`300378`一只股票进行测试。
- 回测时间段为`2014-01-01`~`2018-12-31`。
- 回测时仓位控制为固定每次购买100股。
- 回测初始资金10000元。
- 回测时避免了简单测试的弊端。采用了第二日购买/卖出的方式，并且计算了手续费。

## 测试回测

与[训练回测](#训练回测)设置一致。仅在以下方面有所区别：

- 回测时间段为`2019-01-01`~`2019-12-31`。
- 仓位控制：
    1. 固定每次购买100股
    2. 使用凯利公式对仓位进行管理。

# 策略说明：

## ATR波幅通道策略

从训练回测的测试结果来看，所有策略的R值均在3以上。应该还算是一个不错的策略。

测试回测的测试结果也对其有了一定程度的验证。R值达到了`4.12`。

测试回测中采用凯利公式对仓位进行控制后，由于单次买入的数量增加（原本平均开仓费用为`1372.12`，现在为`4315.54`），资金利用率由`19.52%`提高至`31.14%`，造成了交易数量由`13`次减少为`8`次（加仓次数减少），胜率由`69.23%`降低至`50.00%`。虽然因为仓位的增大带来了更高的亏损交易平均交易额（相对扩大`142.84%`），但是也正是因此而带来了更高的盈利交易平均盈利额（相对扩大`252.93%`）。所以最终R值由`4.12`上升至`4.14`。最终利润由`37.90%`上升至`59.45%`。

### 策略说明：

- 买入：收盘价上穿20日移动均线+20日ATR
- 买入（加仓）：收盘价高于20日移动均线+20日ATR，并且收盘价超过现有持仓的当时买入价+2倍买入日ATR
- 卖出：收盘价下穿20日移动均线+20日ATR
- 卖出：持仓达到20日（以历史数据的亏损交易平均持仓时间为值），并且当日价格小于或等于现有持仓的当时买入价

### 训练回测结果：

|                                                                                      |   盈亏总额 |   最终价值 |   交易次数 |   盈利次数 |   亏损次数 |   盈利比率 |   每笔交易平均盈亏额 |   盈利交易平均盈利额 |   亏损交易平均亏损额 |    R |   最大回撤 |   买入平均花费 |
|:-------------------------------------------------------------------------------------|-----------:|-----------:|-----------:|-----------:|-----------:|-----------:|---------------------:|---------------------:|---------------------:|-----:|-----------:|---------------:|
| 回测-通道策略-ATR波幅通道                                                            |   16441.3  |    24605.9 |         52 |         28 |         24 |   0.538462 |              280.795 |              587.189 |             -76.665  | 3.66 |  -0.223107 |        2209.86 |
| 回测-通道策略-ATR波幅通道-增加最多持仓天数的卖出策略                                 |   16225.9  |    25080.6 |         52 |         27 |         25 |   0.519231 |              281.939 |              600.96  |             -62.6025 | 4.5  |  -0.223107 |        2217.84 |
| 回测-通道策略-ATR波幅通道-增加止损(1倍ATR）止盈（10倍ATR）                           |   16441.3  |    24605.9 |         52 |         28 |         24 |   0.538462 |              280.795 |              587.189 |             -76.665  | 3.66 |  -0.223107 |        2209.86 |
| 回测-通道策略-ATR波幅通道-增加有持仓情况下2倍ATR时的加仓策略                         |   20867.4  |    28315.8 |         60 |         32 |         28 |   0.533333 |              305.168 |              652.107 |             -91.3329 | 3.34 |  -0.267097 |        2293.85 |
| 回测-通道策略-ATR波幅通道+最多持仓天数+2倍ATR加仓的策略                              |   20829.2  |    28809.5 |         60 |         31 |         29 |   0.516667 |              309.429 |              671.91  |             -78.0504 | 3.96 |  -0.267097 |        2297.82 |

### 测试回测结果：

|                                                                                      |   盈亏总额 |   最终价值 |   交易次数 |   盈利次数 |   亏损次数 |   盈利比率 |   每笔交易平均盈亏额 |   盈利交易平均盈利额 |   亏损交易平均亏损额 |    R |   最大回撤 |   买入平均花费 |
|:-------------------------------------------------------------------------------------|-----------:|-----------:|-----------:|-----------:|-----------:|-----------:|---------------------:|---------------------:|---------------------:|-----:|-----------:|---------------:|
| 回测-通道策略-ATR波幅通道+最多持仓天数+2倍ATR加仓的策略(2019年数据)                  |    3790.53 |    13610.8 |         13 |          9 |          4 |   0.692308 |              271.289 |              421.17  |             -65.9443 | 4.11 |  -0.310902 |        1372.12 |
| 回测-通道策略-ATR波幅通道+最多持仓天数+2倍ATR加仓的策略+凯利公式仓位控制(2019年数据) |    5945.68 |    15575.7 |          8 |          4 |          4 |   0.5      |              663.138 |             1486.42  |            -160.143  | 4.14 |  -0.333603 |        4315.54 |


## 短期均线穿越长期均线（双均线）

从训练回测测试结果来看，所有策略的R值均小于3。增加有持仓情况下2倍ATR时的加仓策略的R值降低至1.07。说明这不是一个非常好的策略。（应该是卖出时机点控制不好，造成了每笔亏损交易的亏损额较大）

### 策略说明：

- 买入：短期均线(10日)上穿长期均线(20日)
- 买入（加仓）：短期均线(10日)高于长期均线(20日)，并且收盘价超过现有持仓的当时买入价+2倍买入日ATR
- 卖出：长期均线(20日)下穿短期均线(10日)
- 卖出：持仓达到15日（以历史数据的亏损交易平均持仓时间为值），并且当日价格小于或等于现有持仓的当时买入价

### 训练回测结果：

|                                                                                        |   盈亏总额 |   最终价值 |   交易次数 |   盈利次数 |   亏损次数 |   盈利比率 |   每笔交易平均盈亏额 |   盈利交易平均盈利额 |   亏损交易平均亏损额 |    R |   最大回撤 |   买入平均花费 |
|:---------------------------------------------------------------------------------------|-----------:|-----------:|-----------:|-----------:|-----------:|-----------:|---------------------:|---------------------:|---------------------:|-----:|-----------:|---------------:|
| 回测-均线策略-短期均线穿越长期均线（双均线）                                           |   6820.67  |   15611.4  |         27 |         15 |         12 |   0.555556 |             207.763  |              454.711 |            -100.922  | 2.06 |  -0.163974 |        2217.06 |
| 回测-均线策略-短期均线穿越长期均线（双均线）-增加最多持仓天数的卖出策略                |   6397.68  |   15127    |         27 |         11 |         16 |   0.407407 |             189.827  |              581.607 |             -79.5218 | 2.39 |  -0.163974 |        2217.06 |
| 回测-均线策略-短期均线穿越长期均线（双均线）-增加止损(1倍ATR）止盈（10倍ATR）          |   6820.67  |   15611.4  |         27 |         15 |         12 |   0.555556 |             207.763  |              454.711 |            -100.922  | 2.06 |  -0.163974 |        2217.06 |
| 回测-均线策略-短期均线穿越长期均线（双均线）-增加有持仓情况下2倍ATR时的加仓策略        |   8799.35  |   15947.3  |         41 |         20 |         21 |   0.487805 |             145.01   |              439.967 |            -135.902  | 1.07 |  -0.265648 |        2402.39 |

### 测试回测结果：

|                                                                                      |   盈亏总额 |   最终价值 |   交易次数 |   盈利次数 |   亏损次数 |   盈利比率 |   每笔交易平均盈亏额 |   盈利交易平均盈利额 |   亏损交易平均亏损额 |    R |   最大回撤 |   买入平均花费 |
|:-------------------------------------------------------------------------------------|-----------:|-----------:|-----------:|-----------:|-----------:|-----------:|---------------------:|---------------------:|---------------------:|-----:|-----------:|---------------:|
| 回测-均线策略-短期均线穿越长期均线（双均线）+最多持仓天数(2019年数据)                  |    370.287 |    9909.92 |          5 |          2 |          3 |   0.4      |             -14.3242 |              185.144 |            -147.303  | 0.1  |  -0.100755 |        1519.92 |
| 回测-均线策略-短期均线穿越长期均线（双均线）+最多持仓天数+凯利公式仓位控制(2019年数据) |    760.574 |   10061.7  |          5 |          2 |          3 |   0.4      |              18.7032 |              380.287 |            -222.353  | 0.08 |  -0.123031 |        2651.36 |




# 策略集合

## 均线策略

* [x] 📈[短期均线穿越长期均线（双均线）](策略测试-均线策略-短期均线穿越长期均线（双均线）.ipynb)
    > 买入：短期均线(10日)上穿长期均线(20日)
    > 
    > 卖出：长期均线(20日)上穿短期均线(10日)
* [x] [价格穿越均线（双均线）](策略测试-均线策略-价格穿越均线（双均线）.ipynb) 
    > 买入：(收盘价上穿10日均线 & 收盘价在20日均线上) | (收盘价上穿20日均线 & 收盘价在10日均线上)
    > 
    > 卖出：10日均线下穿收盘价 | 20日均线下穿收盘价
* [x] [均线方向（双均线）](策略测试-均线策略-均线方向（双均线）.ipynb)
    > 买入：两条均线（10日，20日）当日数据>昨日数据>前日数据
    > 
    > 卖出：两条均线（10日，20日）当日数据<昨日数据<前日数据

## 通道策略

* [ ] [均线百分比通道]()
    > 买入：
    > 
    > 卖出：
* [x] 📈[布林带通道](策略测试-通道策略-布林带通道.ipynb) 
    > 买入：收盘价上穿布林带上轨（买入）
    > 
    > 卖出：收盘价下穿布林带中轨（卖出）
    > 
    > `使用30日线，上下1.5倍标准差`
* [x] 📈[ATR波幅通道](策略测试-通道策略-ATR波幅通道.ipynb)
    > 买入：收盘价上穿20日移动均线+20日ATR
    > 
    > 卖出：收盘价下穿20日移动均线+20日ATR
* [x] [高低价通道](策略测试-通道策略-高低价通道.ipynb)
    > 买入：收盘价高于前30日最高收盘价
    > 
    > 卖出：收盘价低于前10日最低收盘价

### 简单测试

|                                         |   盈利交易平均盈利比率 |   最大盈利比率 |   亏损交易平均亏损比率 |   最大亏损比率 |   平均盈亏比率 |   交易次数 |   总天数 |   平均持仓天数 |   R(平均利润/平均损失) |
|:----------------------------------------|-----------------------:|---------------:|-----------------------:|---------------:|---------------:|-----------:|---------:|---------------:|-----------------------:|
| 简单测试-短期均线穿越长期均线（双均线） |               0.197792 |         0.8529 |             -0.0469693 |      -0.109115 |      0.0642859 |         33 |     1442 |        20.8485 |                2.25487 |
| 简单测试-价格穿越均线（双均线） |               0.106895 |       0.526032 |             -0.0317964 |           -0.1 |      0.0149366 |         92 |     1442 |        6.92391 |               0.400861 |
| 简单测试-均线方向（双均线） |               0.181977 |       0.896483 |             -0.0658363 |      -0.415899 |      0.0286772 |        763 |     1442 |        18.6855 |                0.26055 |
| 简单测试-通道策略-布林带通道 |               0.262513 |       0.726888 |             -0.0618243 |      -0.124599 |      0.0690488 |         57 |     1442 |        23.4035 |                1.32005 |
| 简单测试-通道策略-ATR波幅通道 |               0.212668 |       0.699342 |             -0.0762628 |      -0.212726 |      0.0269269 |         70 |     1442 |        26.2571 |               0.310914 |
| 简单测试-通道策略-高低价通道 |               0.113351 |       0.357523 |             -0.0865514 |      -0.274962 |      -0.013083 |        117 |     1442 |        16.3333 |               0.011991 |

### 回测

|                                     |   盈亏总额 |   最终价值 |   交易次数 |   盈利次数 |   亏损次数 |   盈利比率 |   每笔交易平均盈亏额 |   盈利交易平均盈利额 |   亏损交易平均亏损额 |    R |   最大回撤 |   买入平均花费 |
|:------------------------------------|-----------:|-----------:|-----------:|-----------:|-----------:|-----------:|---------------------:|---------------------:|---------------------:|-----:|-----------:|---------------:|
| 📈回测-短期均线穿越长期均线（双均线） |    6820.67 |    15611.4 |         27 |         15 |         12 |   0.555556 |              207.763 |              454.711 |             -100.922 | 2.06 |  -0.163974 |        2217.06 |
| 回测-价格穿越均线（双均线） |    7281.94 |    10811.6 |         79 |         24 |         55 |   0.303797 |              10.2673 |              303.414 |             -117.651 | 0.09 |  -0.278277 |        2607.59 |
| 回测-均线方向（双均线） |    25261.8 |    12046.1 |        352 |        137 |        215 |   0.389205 |              15.1356 |              184.393 |             -92.7167 | 0.16 |  -0.465173 |        2223.76 |
| 📈回测-通道策略-布林带通道 |    12062.4 |    19589.8 |         39 |         17 |         22 |   0.435897 |              245.814 |              709.552 |             -112.528 | 2.18 |  -0.232387 |        2501.61 |
| 📈回测-通道策略-ATR波幅通道 |    16441.3 |    24605.9 |         52 |         28 |         24 |   0.538462 |              280.795 |              587.189 |              -76.665 | 3.66 |  -0.223107 |        2209.86 |
| 回测-通道策略-高低价通道 |    6721.25 |    12505.1 |         53 |         18 |         35 |   0.339623 |              47.2479 |              373.403 |             -120.489 | 0.39 |  -0.228241 |        2237.59 |


